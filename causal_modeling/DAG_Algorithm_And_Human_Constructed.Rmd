---
title: "DAG Built with Algorithm and Human Influence"
author: "Chloe Larkin"
date: "12/14/2020"
output: html_document
---

# Load bnlearn and graph visualization libraries
```{r}
library(bnlearn);
library(Rgraphviz);
```

# Read in the COVID data
```{r}
data = read.delim("../datasets/dag_data_V3.csv", sep = ",");
```

# Use a bnlearn constraint-based structure learning algorithm to generate a DAG algorithmically
```{r}
algo_generated_dag = iamb(
  data,
  blacklist = matrix(
    c(
      # County characteristic variables can have directed edges toward CDC compliance, but not vice versa.
      "CDC", "MI", 
      "CDC", "CPL", 
      "CDC", "HS", 
      "CDC", "SPL", 
      "CDC", "UI", 
      
      # Bans on large gatherings should not have a directed edge to any county characteristic.
      "BLG", "ICU",
      "BLG", "CPL",
      "BLG", "HS",
      "BLG", "MI",
      "BLG", "UI",
      "BLG", "SPL",
      
      # ICU bed availability should not have a directed edge to the other county characteristic variables.
      "ICU", "HS",
      "ICU", "CPL",
      "ICU", "SPL",
      "ICU", "UI",
      "ICU", "MI",
      "ICU", "CDC", # ICU bed availability should not have a directed edge to CDC compliance
      
      # Percentage of residents with a high school diploma could have directed edges to political leanings, 
      # but not vice versa.
      "CPL", "HS",
      "SPL", "HS",
      
      # Each node could have a directed edge to county cases, but not vice versa.
       "CC","CPL",
       "CC","HS", 
       "CC","MI",
       "CC","UI", 
       "CC","CDC", 
       "CC","SPL", 
       "CC","BLG",
       "CC","ICU"
    ),
    ncol = 2,
    byrow = TRUE
  ),
  undirected = FALSE,
  debug = TRUE
)
```

# Plot the algorithmically generated DAG.
```{r}
plot(algo_generated_dag)
```
```{r}
mb(algo_generated_dag, "CC")
```

*Insights drawn from the algorithmically-generated DAG:*
Contrary to our expectations, there is not a directed edge from CDC compliance to our outcome variable CC in the algorithmically generated DAG. 
The CDC compliance variable has no outgoing edges. 
The Markov blanket of county Covid case rate in the algorithmically generated DAG is ["HS", "SPL", "BLG"] -- high school education, 
the county's state's political leaning, and whether the county's state has enacted bans on large gatherings. 

*Construct a PDAG from the algorithmically generated DAG:*
With the knowledge that we can only learn a causal structure up to an equivalence class, we generalize the algorithmically generated DAG into its
PDAG form:

# Create a PDAG from the algorithmically generated DAG, using bnlearn's "cpdag" tool.
```{r}
algo_pdag <- cpdag(algo_generated_dag, debug=FALSE)
```

# Plot the PDAG of the algorithmically generated DAG.
```{r}
graphviz.plot(algo_pdag)
```


*Plans to modify the algorithmically generated PDAG with expert knowledge*:
In the PDAG, there is are undirected edge between all three variables in the CC (county Covid cases) node's Markov blanket: SPL (state political leaning),
BLG (bans on large gatherings), and HS (proportion of population with a high school diploma). Although these edges are undirected in the equivalence class
of the algorithmically generated DAG, human domain knowledge provides the intuition that the edge between SPL and HS should be directed as: HS --> SPL.
We justify this because the voting age is 18, and few individuals earn high school diplomas after reaching voting age.

Further, we choose to modify the undirected edge between SPL and BLG such that it is directed as: SPL --> BLG. 
Intuitively, whether a state puts bans on large gatherings should not influence the state's existing political leadership.
On the other hand, we hypothesize state leaders' political allegiances to influential figures who are pro- or anti- Covid regulation may influence
whether the state enacts bans on large gatherings.
